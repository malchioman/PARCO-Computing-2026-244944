


# Parallel Sparse Matrix–Vector Multiplication in CSR Format (OpenMP)

##  Introduction

This project contains the implementation used for the study:

**Parallel Sparse Matrix–Vector Multiplication in CSR Format on Multicore CPUs with OpenMP**  
Author: **Massimo Malchiodi**, University of Trento

The repository provides a complete OpenMP-based implementation of **Sparse Matrix–Vector Multiplication (SpMV)** in **Compressed Sparse Row (CSR)** format.  
The computation is parallelized using a **row-wise loop decomposition** with configurable OpenMP scheduling (`static`, `dynamic`, `guided`).

The project includes:

- The main CSR SpMV executable (`spmv_csr`)
- Tools to generate matrices (`make_matrices`, `custom_matrix`)
- Support for the **Matrix Market (.mtx)** format through the NIST `mmio` library
- Scripts to run automated benchmarks on regular and irregular matrices

All executables are copied automatically into:

```

bin/

```

Input matrices (generated or downloaded) are stored in:

```

bin/matrices/

````

---

##  Requirements and Environment Setup

###  Requirements

To build and run the project you need:

- **CMake ≥ 3.15**
- **C++17 compiler** with OpenMP support  
  - GCC ≥ 9 (Linux)
  - Clang / Apple Clang (macOS)
  - MSVC or MinGW-w64 (Windows)
- Matrix Market I/O library (included as `mmio.c`)

---

### Clone the Repository

```bash
git clone https://github.com/malchioman/PARCO-Computing-2026-244944.git
cd PARCO-Computing-2026-244944
````


---

### Build Instructions

make sure to be in PARCO-Computing-2026-244944 directory
#### Linux / macOS

```bash
mkdir build  
cd build      
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build .
cd ..
```

After building, executables will appear in:

```
bin/
```

#### Windows (Visual Studio)

```bat
mkdir build
cd build
cmake .. -G "Visual Studio 17 2022" -A x64
cmake --build . --config Release
cd ..
```

Executables will be placed in:

```
bin\
```

---

## Generate Matrices (Required Before Running SpMV)
### Matrix generation:

All matrices used in the experiments are generated by the `make_matrices`
executable.  
They are written in **Matrix Market (.mtx)** format into:


To generate all standard matrices:

```bash
./bin/make_matrices
```

---
The following matrices are created by default:

| File Name           | Size (n × n)        | NNZ (approx.) | Type / Pattern                      | Description |
|---------------------|----------------------|----------------|--------------------------------------|-------------|
| **reg_150k.mtx**    | 150,000 × 150,000    | ~450,000       | 1-D Poisson (tridiagonal)            | Extremely regular, uniform row lengths |
| **irreg_50k.mtx**   | 50,000 × 50,000      | ~1,000,000     | Random sparse, fixed *k* nnz/row     | Irregular structure; good for dynamic/guided tests |
| **fem_5k.mtx**      | 5,154 × 5,154        | 99,199         | Random sparse, exact nnz             | FEM-like mesh sparsity pattern |
| **therm_1k.mtx**    | 1,228 × 1,228        | 8,598          | Random sparse, exact nnz             | Thermal simulation–style matrix |
| **rail_4k.mtx**     | 4,284 × 4,284        | 110,000        | Random sparse, exact nnz             | Medium irregular graph-like matrix |

All matrices use:

- 1-based indexing (Matrix Market convention)
- real, general, coordinate format
- internally built in CSR and exported to .mtx

make_matrices can also generate two optional, much larger matrices:

| File Name           | Size (n × n)         | NNZ        | Pattern                      | How to Enable |
|---------------------|-----------------------|------------|------------------------------|----------------|
| **social_280k.mtx** | 281,903 × 281,903     | 2,300,000  | Social-network-like graph    | `--social`     |
| **web_1M.mtx**      | 1,000,005 × 1,000,005 | 3,100,000  | Web-graph-style sparse graph | `--web`        |

using these commands:
```bash
./bin/make_matrices --social
./bin/make_matrices --web
```

---

#### Controlling the Irregularity of irreg_50k.mtx:

The matrix irreg_50k.mtx is generated using:
```bash
random_sparse_k(50000, k_irreg);
```

---

Where k_irreg is the number of nonzeros per row (default = 20).

You can modify this parameter with:
```bash
./bin/make_matrices --k 10     # very sparse
./bin/make_matrices --k 50     # denser
./bin/make_matrices --k 200    # heavy irregularity

```

---
Both forms are accepted:
```bash
./bin/make_matrices --k 35
./bin/make_matrices --k35
```

---

This is useful for stress-testing SpMV under different irregularity conditions.
### Generate custom random matrices (`custom_matrix`)

The `custom_matrix` executable generates a **random sparse matrix** with user-defined size and density.

Its logic is:

* creates directory `matrices/`
* sets default size = 10,000 × 10,000
* sets density = 0.5
* computes `nnz = rows × cols × density`
* writes a Matrix Market file with random:

    * row indices (1 to rows)
    * column indices (1 to cols)
    * values in [-10, +10]

The output file is always:

```
matrices/custom.mtx
```

### Usage

The program accepts also  **three optional parameters**:

- `rows` – number of matrix rows (integer)
- `cols` – number of matrix columns (integer)
- `density` – fraction of nonzero elements (0–1)

If parameters are omitted, all defaults are used.

---

## Examples

Below are some practical examples of how to generate custom random matrices
using the `custom_matrix` executable.

---

- 1. Generate the default matrix (10,000 × 10,000, density = 0.5)**

```bash
cd bin
./custom_matrix

```
---
- 2. Generate a 2,000 × 2,000 matrix with density 0.10
```bash
./custom_matrix 2000 2000 0.10

```
This produces a sparse matrix with approximately:
```bash
nnz ≈ 2000 × 2000 × 0.10 = 400,000 nonzeros

```
---
- 3. Generate a tall matrix: 50,000 × 1,000 with density 0.02
```bash
./custom_matrix 50000 1000 0.02


```
Useful for testing SpMV performance on highly non-square matrices.

---
4. Generate a very sparse matrix (density = 0.001)
```bash   
./custom_matrix 10000 10000 0.001


```
This generates:
```bash
nnz ≈ 10000 × 10000 × 0.001 = 100,000 nonzeros

```

---
5. Generate a
 dense-like sparse matrix (density = 0.8)
```bash   
./custom_matrix 5000 5000 0.8


```
This produces a heavy matrix with:
```bash
nnz ≈ 5000 × 5000 × 0.8 = 20,000,000 nonzeros

```
### ⚠️ Generation may take longer and produce a large file.

---

## Scripts and Executables

###  Provided Scripts

The repository includes helper scripts to automatically execute benchmarks on two predefined scenarios:

* **Regular matrix → OpenMP `static` scheduling**
* **Irregular matrix → OpenMP `dynamic` scheduling**

both with 20 threads and 64 chunks

These scripts are *optional* but useful for reproducible tests, in order to make easier the comparison between sequential and parallel code the repository included also:

- a script for the sequential multiplication of a regular matrix,
- a script for the sequential multiplication for the irregular matrix 

#### Linux / macOS

```bash
./script/runreg.sh    # Regular matrix, static scheduling
./script/runirr.sh    # Irregular matrix, dynamic scheduling
./script/seqreg.sh    # sequential matrix vectror multiplication with a regular matrix
./script/seqirr.sh    # sequential matrix vectror multiplication with an irregular matrix
```

#### Windows (PowerShell)

```powershell
.\script\runreg.ps1
.\script\runirr.ps1
.\script\seqreg.ps1   
.\script\seqreg.ps1   
```

### Script Execution Permissions on HPC Clusters

When accessing some HPC clusters or shared Linux environments, the shell scripts included in the repository may not have execution permissions immediately after cloning the project.  
If running a script results in a **“Permission denied”** error, for example:

```bash
./script/runreg.sh
```
you must first grant execution rights. To make all scripts executable at once, run:

```bash
chmod +x script/*.sh
```
Alternatively, you can enable individual scripts:

```bash
chmod +x script/runreg.sh script/runirr.sh script/seqreg.sh script/seqirr.sh
```
After setting the permissions, all scripts will run normally using the commands shown in this README.
---

### Running the Main Executable (`spmv_csr`)

Use this executable to manually perform your own experiments.

Syntax:

```bash
./bin/spmv_csr <matrix.mtx> <threads> [static|dynamic|guided] [chunk] [repeats] [trials]
```

Parameters:

| Argument                | Description                                          |
| ----------------------- | ---------------------------------------------------- |
| `<matrix.mtx>`          | Input matrix in Matrix Market format                 |
| `<threads>`             | Number of OpenMP threads                             |
| `static/dynamic/guided` | Scheduling policy                                    |
| `[chunk]`               | Optional: OpenMP chunk size                          |
| `[repeats]`             | Optional: number of inner repetitions                |
| `[trials]`              | Optional: independent trials (P90 computed over all) |


### Numerical validation

At the beginning of each run, `spmv_csr` performs a numerical validation step:
the OpenMP result is compared against a single-thread CSR reference
implementation. Two metrics are reported on `stderr`:

- `rel_L2_err` – relative L2 error ‖y_par − y_ref‖₂ / ‖y_ref‖₂
- `max_abs_err` – maximum absolute difference maxᵢ |y_par[i] − y_ref[i]|

This check runs once per execution and is not included in the timing loop
used to compute P90, GFLOP/s, and GB/s. For the matrices used in the report,
both errors are identically zero in single precision.

#### Example commands

```bash
# Static scheduling, 12 threads
./bin/spmv_csr bin/matrices/irreg_50k.mtx 12 static
```

```bash
# Dynamic scheduling, chunk=64, 10 repeats, 5 trials
./bin/spmv_csr bin/matrices/irreg_50k.mtx 20 dynamic 64 10 5
```

```bash
# Guided scheduling on a custom-generated matrix
./bin/spmv_csr bin/matrices/large_random.mtx 24 guided 128 5 3
```

---

### Summary of Executables

| Executable        | Description                                                                   |
| ----------------- | ----------------------------------------------------------------------------- |
| **spmv_csr**      | Runs the CSR SpMV kernel with configurable OpenMP scheduling                  |
| **make_matrices** | Generates default test matrices in `bin/matrices/`                            |
| **custom_matrix** | Generates a random matrix (`large_random.mtx`) with configurable size/density |
| **mmio**          | Utility for Matrix Market read/write (internal use)                           |
| **gen_matrix**    | Additional matrix generator (if enabled in CMake)                             |

---

## Notes

* All executables must be run **from the project root or from inside `bin/`**, depending on paths.
* Matrix Market files must reside in `bin/matrices/`.
* For best performance, always compile in `Release` mode.

---
